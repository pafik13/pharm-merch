           .exec(function(err, attendances) {
                if (err) sails.log.error(err);

                var results = [];

                if (!attendances) {
                    sails.log.error("Attendances NOT found");
                } else {
                    attendances.forEach(function(attendance) {
                        console.log(attendance.id);

                        AttendancePhoto.find({
                                attendance: attendance.id
                            })
                            .exec(function(err, attendancePhotos) {
                                if (err) sails.log.error(err);

                                if (!attendancePhotos.length) {
                                    sails.log.error("AttendancePhoto NOT found");
                                    results.push(attendance);
                                } else {
                                    sails.log.info("AttendancePhoto is found");
                                    sails.log.info(attendancePhotos.length);

                                    attendance.gpsDist = Number.MAX_VALUE;

                                    attendancePhotos.forEach(function(attPhoto) {
                                        var ext = require('../extensions.js');

                                        console.log(attPhoto.id);
                                        sails.log.info(attendance.pharmacy);

                                        sails.log.info(attendance.pharmacy.longitude);
                                        sails.log.info(attendance.pharmacy.latitude);
                                        sails.log.info(attPhoto.longitude);
                                        sails.log.info(attPhoto.latitude);

                                        attendance.gpsDist = Math.min(
                                            attendance.gpsDist,
                                            ext.distance(
                                                attendance.pharmacy.longitude,
                                                attendance.pharmacy.latitude,
                                                attPhoto.longitude,
                                                attPhoto.latitude
                                            ));

                                        sails.log.info(attendance.gpsDist);

                                    });
                                    if (attendance.gpsDist == Number.MAX_VALUE) {
                                        attendance.gpsDist = NaN;
                                    };
                                    attendance.gpsDist = Math.round(attendance.gpsDist);
                                    sails.log.info("Befor push: " + attendance.gpsDist);
                                    results.push(attendance);
                                }
                            });
                    });
                    return res.view('weekly', {
                        reportRows: results,
                        count: results.length
                    });
                }
            });



VVVV222222

            .then(function(attendances) {
                var attendancePhotos = AttendancePhoto.find({
                        attendance: _.pluck(attendances, 'id')
                    })
                    .then(function(attendancePhotos) {
                        return attendancePhotos;
                    });
                return [attendances, attendancePhotos];
            })
            .spread(function(attendence, attendancePhotos) {
                var attendancePhotos = _.indexBy(attendancePhotos, 'id');
                // //_.indexBy: Creates an object composed of keys generated from the results of running each element of the collection through the given callback. The corresponding value of each key is the last element responsible for generating the key
                // merchant.attendences = _.map(merchant.attendences, function(attendence) {
                //     attendence.pharmacy = attendencePharmacy[attendence.pharmacy];
                //     return attendence;
                // });
                res.json(attendancePhotos);
            })
            .catch(function(err) {
                if (err) {
                    return res.serverError(err);
                }
            });